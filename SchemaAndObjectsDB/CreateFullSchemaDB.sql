BEGIN EXECUTE IMMEDIATE 'DROP TABLE Orders'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Schedules'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Movies'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Halls'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Users'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Roles'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/

CREATE TABLE Roles (
    Id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    Name NVARCHAR2(50) NOT NULL UNIQUE,
    CONSTRAINT pk_roles PRIMARY KEY (Id)
);

CREATE TABLE Users (
    Id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    Name NVARCHAR2(100) NOT NULL,
    Surname NVARCHAR2(100) NOT NULL,
    Email NVARCHAR2(255) NOT NULL UNIQUE,
    Password NVARCHAR2(100) NOT NULL,
    RoleId NUMBER NOT NULL,
    CONSTRAINT pk_users PRIMARY KEY (Id),
    CONSTRAINT fk_users_roles FOREIGN KEY (RoleId) REFERENCES Roles(Id)
);

CREATE TABLE Movies (
    Id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    Title NVARCHAR2(255) NOT NULL UNIQUE,
    Director NVARCHAR2(255),
    Description NCLOB,
    Genre NVARCHAR2(100),
    Duration NUMBER,
    Rating NUMBER(3, 1),
    AgeRestriction NVARCHAR2(10),
    Poster BLOB,
    Trailer BLOB,
    CONSTRAINT pk_movies PRIMARY KEY (Id)
);

CREATE TABLE Halls (
    Id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    Name NVARCHAR2(100) NOT NULL UNIQUE,
    Capacity NUMBER NOT NULL,
    Type NVARCHAR2(50),
    CONSTRAINT pk_halls PRIMARY KEY (Id)
);

CREATE TABLE Schedules (
    Id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    ShowTime TIMESTAMP NOT NULL,
    MovieId NUMBER NOT NULL,
    HallId NUMBER NOT NULL,
    CONSTRAINT pk_schedules PRIMARY KEY (Id),
    CONSTRAINT fk_schedules_movies FOREIGN KEY (MovieId) REFERENCES Movies(Id) ON DELETE CASCADE,
    CONSTRAINT fk_schedules_halls FOREIGN KEY (HallId) REFERENCES Halls(Id) ON DELETE CASCADE
);

CREATE TABLE Orders (
    Id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    Seats NVARCHAR2(255) NOT NULL,
    TotalPrice NUMBER(10, 2) NOT NULL,
    OrderStatus NVARCHAR2(50) DEFAULT 'Забронирован' NOT NULL,
    BookingTimestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UserId NUMBER, 
    ScheduleId NUMBER NOT NULL,
    CONSTRAINT pk_orders PRIMARY KEY (Id),
    CONSTRAINT fk_orders_users FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE,
    CONSTRAINT fk_orders_schedules FOREIGN KEY (ScheduleId) REFERENCES Schedules(Id) ON DELETE CASCADE
);